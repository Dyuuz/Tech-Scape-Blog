{% extends 'layout.html' %}
{%load static%}

{% block hero %}

{% endblock  %}

{%block featured%}
<div class="blog-register-body">
    <div class="blog-register-container">
      <section class="forms-section">
        <h1 class="section-title-login">Welcome to Tech-Scape </h1>
        <p class="log-title">Input credentials to continue</p>
      </section>
      <form class="blog-register-form" id="loginForm" method="POST">
          {% csrf_token %}
          <h6 class="newh6">Username</h6> 
          <input class="blog-register-input" type="text" name="username" placeholder="Input username" autocomplete="on" required>
          
          <h6 class="newh6">Password</h6> 
          <input class="blog-register-input" id="password" type="password" name="password" placeholder="Input password" autocomplete="on" required>
          
          <p class="blog-register-alert">
            
          </p>
            <button class="blog-register-button" type="submit" >Login</button>
      </form>
      <p class="blog-register-text">
          Don't have an account? <a href="{% url 'register' %}">Register</a>
      </p>
      <p class="blog-register-password">
          <a href="{% url 'verify' %}">Forgot password?</a>
      </p>
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
      <script>
        var user = document.querySelector('input[name="username"]');
        var password = document.querySelector('input[name="password"]');
        var alert = document.querySelector('.blog-register-alert');

        user.addEventListener('input', function() {
          alert.textContent = '';
          //alert.style.display = 'none';
        });

        password.addEventListener('input', function() {
          alert.textContent = '';
          //alert.style.display = 'none';
        });

        document.getElementById('loginForm').onsubmit = function(event) {
          var password = document.getElementById('password').value;
          var alert = document.querySelector('.blog-register-alert');
          var form = document.getElementById('loginForm');
          var formData = new FormData(form);
          this.action = getLoginUrl(formData);
        };

        function getLoginUrl(formData) {
          var alert =  document.querySelector('.blog-register-alert');
          alert.style.display = 'block';
          const csrf_token = document.querySelector('input[name="csrfmiddlewaretoken"]').value;

          axios.post('login', formData,
          { headers: {
            'X-CSRFToken': csrf_token
          }}
          )
          .then(response => {
            if (response.data.success === true) {
              Swal.fire({
                title: 'Login Successful',
                text: 'Redirecting to homepage',
                icon: 'success',
                timer: 4000,
                showConfirmButton: false
            });
              setTimeout(function() {
              window.location.href = response.data.redirect_url;
              }, 4000);
              
              //window.location.href = response.data.redirect_url;
              
            } else if (response.data.exceptionError === true) {
              alert.textContent = response.data.message;

            } else if(response.data.userError === true) {
              alert.textContent = response.data.message;

            } else if(response.data.passworderror === true) {
              alert.textContent = response.data.message;
            }
          })
            .catch(error => {
            console.error('Error:', error);
            if (error.response) {
              Swal.fire({
                title: 'Login Failed!',
                text: 'Request error, refresh page to login',
                icon: 'error',
                timer: 4000,
                showConfirmButton: false
            });
            } else if (error.request) {
              // The request was made but no response was received
              alert.textContent = 'Please check your network connection.';
            } else {
              // Something happened in setting up the request that triggered an Error
              alert.textContent = 'An error occurred while setting up the request: ' + error.message;
            }
            });
          event.preventDefault();
        }

        function submitForm() {
          var passwordPattern = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*])[A-Za-z\d!@#$%^&*]{8,}$/;
          if (!passwordPattern.test(password)) {
            alert.style.display = 'block';
            alert.textContent = 'Password must be at least 8 characters long, include both upper and lower case letters, a number, and a special character.';
            
            setTimeout(function() {
              alert.style.display = 'none';
            }, 10000); 
            event.preventDefault(); 
          }
          
      }
      
      </script>
    </div>
</div>
{% endblock  %}

{% block usercontents %}

{% endblock  %}

{% block populartags %}

{% endblock  %}

{% block recents %}

{% endblock  %}